# UDP

- [UDP](#udp)
  - [整理](#整理)
    - [面向数据报的运输层协议](#面向数据报的运输层协议)
    - [UDP 封装](#udp-封装)
    - [UDP 规范](#udp-规范)
    - [不可靠性](#不可靠性)
    - [UDP 首部](#udp-首部)
      - [UDP 长度](#udp-长度)
    - [UDP 校验和](#udp-校验和)
    - [IP 分片](#ip-分片)
      - ["不分片"位](#不分片位)
    - [UDP输入队列](#udp输入队列)
    - [端口重用](#端口重用)
    - [限制远端 IP 地址](#限制远端-ip-地址)
    - [UDP 服务器本身可以创建的三类地址绑定](#udp-服务器本身可以创建的三类地址绑定)
    - [每个端口有多个接收者](#每个端口有多个接收者)
    - [帧过滤](#帧过滤)
    - [广播](#广播)
      - [四种 IP 广播地址](#四种-ip-广播地址)
      - [广播是怎样传送的？路由器及主机又如何处理广播？](#广播是怎样传送的路由器及主机又如何处理广播)
    - [多播](#多播)
      - [多播组地址](#多播组地址)
      - [主机组 (host group)](#主机组-host-group)
      - [多播组地址到以太网地址的转换](#多播组地址到以太网地址的转换)

## 整理

### 面向数据报的运输层协议

进程的每个输出操作都正好产生一个 UDP 数据报，并组装成一份待发送的 IP 数据报

### UDP 封装

    |<------------ IP Datagram ------------------->|
    |               |<------ UDP Datagram -------->|
    +---------------+-------+----------------------+
    |       IP      | UDP   |       UDP Data       |
    |     Header    |Header |                      |
    +---------------+-------+----------------------+
	|   20 bytes    |8 bytes|
	|(No IP Options)|       |

### UDP 规范

[RFC 768](https://datatracker.ietf.org/doc/html/rfc768)

### 不可靠性

不保证到达目的地

### UDP 首部

	 0      7 8     15 16    23 24    31
	+--------+--------+--------+--------+
	|     Source      |   Destination   |
	|      Port       |      Port       |
	+--------+--------+--------+--------+
	|                 |                 |
	|     Length      |    Checksum     |
	+--------+--------+--------+--------+
	|
	|          data octets ...
	+---------------- ...

#### UDP 长度

- UDP 长度字段指的是 UDP 首部和 UDP 数据的字节长度

- UDP 长度字段占8字节

- 允许发送0字节的 UDP 数据报

- UDP长度字段是冗余的, UDP 数据报长度等于 IP 数据报长度减去 IP 首部的长度

### UDP 校验和

- UDP 的检验和是可选的

- 计算校验和时包括12字节长的伪首部

- UDP 检验和(事实上，TCP/IP 协议簇中所有的检验和)是简单的16 bit和。它们检测不出交换两个16 bit的差错

### IP 分片

- IP 把 MTU 与数据报长度进行比较，如果需要则进行分片

- 分片可以发生在原始发送端主机上，也可以发生在中间路由器上

- 把一份 IP 数据报分片以后，只有到达目的地才进行重新组装(这里的重新组装与其他网络协议不同，它们要求在下一站就进行进行重新组装，而不是在最终的目的地)

- 重新组装由目的端的 IP 层来完成，其目的是使分片和重新组装过程对运输层(T CP 和 UDP)是透明的

- 已经分片过的数据报有可能会再次进行分片(可能不止一次)

- IP 首部中包含的数据为分片和重新组装提供了足够的信息

- 使用 UDP 很容易导致 IP 分片

#### "不分片"位

如果将这一比特置 1，IP 将不对数据报进行分片。相反把数据报丢弃并发送一个 ICMP 差错报文给起始端

### UDP输入队列

- 通常程序所使用的每个 UDP 端口都与一个有限大小的输入队列相联系。这意味着，来自不同客户的差不多同时到达的请求将由 UDP 自动排队。接收到的 UDP 数据报以其接收顺序交给应用程序

- 排队溢出造成内核中的 U D P模块丢弃数据报的可能性是存在的

### 端口重用

有可能在相同的端口上启动不同的服务器，每个服务器具有不同的本地 IP地址。但是，一般必须告诉系统应用程序重用相同的端口号没有问题。使用 sockets API 时，必须指定 SO_REUSEADDR socket 选项

### 限制远端 IP 地址

使用伯克利派生系统中指定远端 IP 地址和端口号时的副作用:

- 如果在指定远端地址时没有选择本地地址，那么将自动选择本地地址。它的值就成为选择到达远端 IP 地址路由时将选择的接口 I P 地址

### UDP 服务器本身可以创建的三类地址绑定

|本地地址|远端地址|描述|
|-|-|-|
|localIP.lport|foreignIP.fport|只限于一个客户|
|localIP.lport|*.*|限于到达一个本地接口的数据报：localIP
|*.lport|*.*|接收发送到lport的所有数据报|
|

### 每个端口有多个接收者

在支持多播的系统上多个端点可以使用同一个 IP 地址和 UDP 端口号，通常需要应用程序设置 SO_REUSEADDR socket 选项。4.4 BSD 支持多播传送，需要应用程序设置一个不同的 socket 选项(SO_REUSEPORT)以允许多个端点共享同一个端口。另外，每个端点必须指定这个选项，包括使用该端口的第一个端点。

当 UDP 数据报到达的目的 IP 地址为广播地址或多播地址，而且在目的 IP 地址和端口号处有多个端点时，就向每个端点传送一份数据报的复制(端点的本地 IP 地址可以含有星号，它可匹配任何目的 IP 地址)。但是，如果 UDP 数据报到达的是一个单播地址，那么只向其中一个端点传送一份数据报的复制。选择哪个端点传送数据取决于各个不同的系统实现

### 帧过滤

通常网卡仅接收那些目的地址为网卡物理地址或广播地址的帧

另外，多数接口均被设置为混合模式，这种模式能接收每个帧的一个复制。作为一个例子，tcpdump使用这种模式

大多数的网卡经过配置都能接收目的地址为多播地址或某些子网多播地址的帧

于以太网，当地址中最高字节的最低位设置为1时表示该地址是一个多播地址，
用十六进制可表示为 01:00:00:00:00:00 (以太网广播地址 ff:ff:ff:ff:ff:ff 可看作是以太网多播地址的特例)

如果网卡收到一个帧，这个帧将被传送给设备驱动程序(如果帧检验和错，网卡将丢弃该帧)。设备驱动程序将进行另外的帧过滤。首先，帧类型中必须指定要使用的协议(IP、ARP等等)。其次，进行多播过滤来检测该主机是否属于多播地址说明的多播组

设备驱动程序随后将数据帧传送给下一层，比如，当帧类型指定为 IP 数据报时，就传往 IP层。IP 根据 IP 地址中的源地址和目的地址进行更多的过滤检测。如果正常，就将数据报传送给下一层(如 TCP 或 UDP)

每次 UDP 收到由 IP 传送来的数据报，就根据目的端口号，有时还有源端口号进行数据报过滤。如果当前没有进程使用该目的端口号，就丢弃该数据报并产生一个 ICMP 不可达报文
(TCP 根据它的端口号作相似的过滤)。如果 UDP 数据报存在检验和错，将被丢弃。

使用广播的问题在于它增加了对广播数据不感兴趣主机的处理负荷。拿一个使用 UDP 广播应用作为例子。如果网内有50个主机，但仅有20个参与该应用，每次这20个主机中的一个发送 UDP 广播数据时，其余30个主机不得不处理这些广播数据报。一直到 UD P 层，收到的 UDP 广播数据报才会被丢弃。这30个主机丢弃 UDP 广播数据报是因为这些主机没有使用这个目的端口

多播的出现减少了对应用不感兴趣主机的处理负荷。使用多播，主机可加入一个或多个多播组。这样，网卡将获悉该主机属于哪个多播组，然后仅接收主机所在多播组的那些多播帧

### 广播

#### 四种 IP 广播地址

- 受限的广播

  受限的广播地址是255.255.255.255。该地址用于主机配置过程中 IP 数据报的目的地址，此时，主机可能还不知道它所在网络的网络掩码，甚至连它的 IP 地址也不知道

  在任何情况下，路由器都不转发目的地址为受限的广播地址的数据报，这样的数据报仅出现在本地网络中

  大多数 BSD 系统将 255.255.255.255 看作是配置后第一个接口的广播地址，并且不提供向
所属具备广播能力的接口传送数据报的功能

- 指向网络的广播

  指向网络的广播地址是主机号为全1的地址。A类网络广播地址为 netid.255.255.255，其中 netid 为A类网络的网络号

  一个路由器必须转发指向网络的广播，但它也必须有一个不进行转发的选择

- 指向子网的广播

  指向子网的广播地址为主机号为全 1且有特定子网号的地址。作为子网直接广播地址的 IP 地址需要了解子网的掩码。例如，如果路由器收到发往 128.1.2.255 的数据报，当B类网络 128.1 的子网掩码为 255.255.255.0 时，该地址就是指向子网的广播地址；但如果该子网的掩码为 255.255.254.0，该地址就不是指向子网的广播地址

- 指向所有子网的广播

  指向所有子网的广播也需要了解目的网络的子网掩码，以便与指向网络的广播地址区分开。指向所有子网的广播地址的子网号及主机号为全 1。例如，如果目的子网掩码为 255.255.255.0，那么 IP 地址 128.1.255.255 是一个指向所有子网的广播地址。然而，如果网络没有划分子网，这就是一个指向网络的广播

  当前的看法是这种广播是陈旧过时的，更好的方式是使用多播而不是对所有子网的广播

#### 广播是怎样传送的？路由器及主机又如何处理广播？

很遗憾，这是难以回答的问题，因为它依赖于广播的类型、应用的类型、 TCP/IP 实现方法以及有关路由器的配置

广播是一种应该谨慎使用的功能。在许多情况下， IP 多播被证明是一个更好的解决办法

### 多播

#### 多播组地址

D类 IP 地址:

            |         28 位          |
    +-+-+-+-+------------------------+
    |1|1|1|0|       多播组ID         |
    +-+-+-+-+------------------------+

D类 IP 地址被称为多播组地址。多播组地址包括为 1110 的最高 4 bit 和多播组号。范围从 224.0.0.0 到 239.255.255.255。

#### 主机组 (host group)

- 能够接收发往一个特定多播组地址数据的主机集合

- 一个主机组可跨越多个网络

- 主机组中成员可随时加入或离开主机组

- 主机组中对主机的数量没有限制，

- 不属于某一主机组的主机可以向该组发送信息

- 一些多播组地址被 IANA 确定为知名地址。它们也被当作永久主机组，这和 TCP 及 UDP 中
的熟知端口相似

#### 多播组地址到以太网地址的转换

IANA 拥有一个以太网地址块，即高位 24 bit 为 00:00:5e(十六进制表示)，这意味着该地址块所拥有的地址范围从 00:00:5e:00:00:00 到 00:00:5e:ff:ff:ff。IANA 将其中的一半分配为多播地址。为了指明一个多播地址，任何一个以太网地址的首字节必须是 01，这意味着与 IP 多播相对应的以太网地址范围从 01:00:5e:00:00:00 到 01:00:5e:7f:ff:ff。

这种地址分配将使以太网多播地址中的 23 bit 与 IP 多播组号对应起来，通过将多播组号中的低位 23 bit 映射到以太网地址中的低位 23 bit 实现

由于多播组号中的最高 5 bit 在映射过程中被忽略，因此每个以太网多播地址对应的多播组是不唯一的。32 个不同的多播组号被映射为一个以太网地址

既然地址映射是不唯一的，那么设备驱动程序或 IP 层就必须对数据报进行过滤。因为网卡可能接收到主机不想接收的多播数据帧。另外，如果网卡不提供足够的多播数据帧过滤功能，设备驱动程序就必须接收所有多播数据帧，然后对它们进行过滤

单个物理网络的多播是简单的。多播进程将目的 IP 地址指明为多播地址，设备驱动程序将它转换为相应的以太网地址，然后把数据发送出去。这些接收进程必须通知它们的 IP 层，它们想接收的发往给定多播地址的数据报，并且设备驱动程序必须能够接收这些多播帧。这个过程就是"加入一个多播组"(使用"接收进程"复数形式的原因在于对一确定的多播信息，在同一主机或多个主机上存在多个接收者，这也是为什么要首先使用多播的原因)。当一个主机收到多播数据报时，它必须向属于那个多播组的每个进程均传送一个复制。这和单个进程收到单播 UDP 数据报的 UDP不同。使用多播，一个主机上可能存在多个属于同一多播组的进程

当把多播扩展到单个物理网络以外需要通过路由器转发多播数据时，复杂性就增加了。需要有一个协议让多播路由器了解确定网络中属于确定多播组的任何一个主机。这个协议就是 Internet 组管理协议(IGMP)






