# Kafka权威指南

- [Kafka权威指南](#kafka权威指南)
  - [第 1 章 初识Kafka](#第-1-章-初识kafka)
    - [1.1 发布与订阅消息系统](#11-发布与订阅消息系统)
    - [1.2 Kafka登场](#12-kafka登场)
      - [1.2.1　消息和批次](#121消息和批次)
      - [1.2.2　模式](#122模式)
      - [1.2.3　主题和分区](#123主题和分区)
      - [1.2.4　生产者和消费者](#124生产者和消费者)
      - [1.2.5 broker和集群](#125-broker和集群)
      - [1.2.6 多集群](#126-多集群)
    - [1.3 为什么选择 Kafka](#13-为什么选择-kafka)
      - [1.3.1 多个生产者](#131-多个生产者)
      - [1.3.2 多个消费者](#132-多个消费者)
      - [1.3.3 基于磁盘的数据存储](#133-基于磁盘的数据存储)
      - [1.3.4 伸缩性](#134-伸缩性)
      - [1.3.5 高性能](#135-高性能)
    - [1.4 数据生态系统](#14-数据生态系统)
  - [第 2 章 安装Kafka](#第-2-章-安装kafka)
    - [2.1 要事先行](#21-要事先行)
      - [2.1.1 选择操作系统](#211-选择操作系统)
      - [2.1.2 安装Java](#212-安装java)
      - [2.1.3 安装Zookeeper](#213-安装zookeeper)

## 第 1 章 初识Kafka

### 1.1 发布与订阅消息系统

- 发布者

  - 消息发送者

- 订阅者

  - 消息接收者

- 消息

  - 数据

- 消息分类

  - 发布者对消息进行分类

  - 订阅者订阅并接收特定类型的消息

- broker
  
  - 发布消息的中心点

  - 发布者不会直接把消息发送给接收者

### 1.2 Kafka登场

- Kafka

  - 基于发布与订阅的消息系统

  - 一般被称为“分布式提交日志”或者“分布式流平台”

#### 1.2.1　消息和批次

- 消息

  - Kafka 的数据单元

  - 由字节数组组成

    - 对于 Kafka 来说，消息里的数据没有特别的格式或含义

  - 键

    - 消息的可选的元数据

    - 键也是一个字节数组

    - 与消息一样，对于 Kafka 来说也没有特殊的含义

    - 当消息以一种可控的方式写入不同的分区时，会用到键

- 批次

  - 为了提高效率，消息被分批次写入 Kafka

  - 批次就是一组消息
  
    - 这些消息属于同一个主题和分区

  - 批次大小

    - 要在时间延迟和吞吐量之间作出权衡

#### 1.2.2　模式

- 消息模式（schema）

  - 定义消息内容

  - 举例

    - JSON/XML

      - 易用、可读性好

      - 缺乏强类型处理能力

      - 不同版本间兼容性不好

    - Apache Avro

      - 是一种序列化框架

      - 消息和消息体是分开的

        - 当模式发生变化时，不需要重新生成代码

      - 支持强类型

      - 支持模式进化

        - 其版本既向前兼容，也向后兼容

#### 1.2.3　主题和分区

- 主题

  - 消息通过主题进行分类

  - 类比

    - 数据库里的表

    - 文件系统里的文件夹

- 分区

  - 主题可分为若干分区

  - 一个分区就是一个提交日志

  - 消息以追加的方式写入分区，后以先入先出顺序读取

- 消息顺序

  - 对于一个主题包含多个分区的情况，无法在整个主题范围内保证消息的顺序

  - 可以保证消息在单个分区内的顺序

#### 1.2.4　生产者和消费者

- Kafka 客户端

  - 生产者

  - 消费者

  - 高级客户端 API

    - Kafka Connect API

      用于数据集成

    - Kafka Streams

      用于流式处理

- 生产者

  - 创建消息

    - 消息会被发布到一个特定主题上

    - 通过消息键和分区器控制消息写入的分区

  - 在其他发布与订阅系统中也成为发布者或写入者

- 消费者

  - 读取消息

    - 订阅一个或多个主题

    - 按照消息的生成顺序读取

    - 通过检查消息的偏移量来区分已经读取过的消息

  - 在其他发布与订阅系统中也成为订阅者或读者

- 偏移量

  - 一种元数据

  - 是一个不断递增的整数值

  - 在给定的分区里，每个消息的偏移量是唯一的

  - 保存

    - 消费者把每个分区最后读取的消息偏移量保存在 Zookeeper 或 Kafka 上

    - 如果消费者关闭或重启，它的读取状态不会丢失

- 消费者群组

  - 一个或多个消费者共同读取一个主题
  
  - 群组保证每个分区只能被一个消费者使用

    - 消费者对分区的所有权关系

      消费者与分区之间的映射

#### 1.2.5 broker和集群

- broker

  - 一个独立的 Kafka 服务器

  - 功能

    - 接收来自生产者的消息

      - 消息设置偏移量

      - 提交消息到磁盘保存

    - 为消费者提供服务

      - 对读取分区的请求作出响应

      - 返回已经提交到磁盘上的消息

  - 性能

    - 单个 broker 可以轻松处理数千个分区以及每秒百万级的消息量

- 集群

  - 集群控制器

    - 每个集群都有一个 broker 同时充当了集群控制器的角色

      - 自动从集群的活跃成员中选举出来

    - 负责管理工作

      - 将分区分配给 broker

      - 监控 broker

- 分区的首领

  - 该分区所从属于的 broker

- 分区复制

  - 分区被分配给多个 broker 时发生

- 保留消息

  - 默认的策略

    - 要么保留一段时间

    - 要么保留到消息达到一定大小

  - 主题可以配置自己的保留策略

    - 紧凑型日志

      - 只有最后一个带有特定键的消息会被保留下来

#### 1.2.6 多集群

- 使用多集群的原因

  - 数据类型分离

  - 安全需求隔离

  - 多数据中心(灾难恢复)

- kafka 的消息复制机制

  只能在单个集群里进行, 不能在多个集群之间进行

- MirrorMaker 工具

  - 可实现集群间的消息复制

  - 核心组件

    - 一个消费者

      从一个集群读取消息

    - 一个生产者

      把消息发送到另一个集群上

    - 生产者与消费者间的队列

### 1.3 为什么选择 Kafka

#### 1.3.1 多个生产者

#### 1.3.2 多个消费者

#### 1.3.3 基于磁盘的数据存储

#### 1.3.4 伸缩性

#### 1.3.5 高性能

### 1.4 数据生态系统

- 大数据生态系统

      在线应用程序         流处理               离线处理
      Apache Solr,        Samza, Spark,        Hadoop
      OpenTSDB            Storm, Flink
           ^                  ^                   ^
           |                  |                   |
           |                  |                   |
      |----v------------------v-------------------v----|
      |                     Kafka                      |
      |--^------------^-------------^---------------^--|
         |            |             |               |
         |            |             |               |
        指标         日志         交易数据       物联网数据

- 使用场景

  - 活动跟踪

  - 传递消息

  - 度量指标和日志记录

  - 提交日志

  - 流处理

## 第 2 章 安装Kafka

### 2.1 要事先行

#### 2.1.1 选择操作系统

#### 2.1.2 安装Java

推荐安装 Java 8

#### 2.1.3 安装Zookeeper

1. 单机服务

   - 安装目录

     `/usr/local/zookeeper`

   - 数据目录

     `/var/lib/zookeeper`

   配置安装 Zookeeper

       # tar -zxf zookeeper-3.4.6.tar.gz
       # mv zookeeper-3.4.6 /usr/local/zookeeper
       # mkdir -p /var/lib/zookeeper
       # cat > /usr/local/zookeeper/conf/zoo.cfg << EOF
       > tickTime=2000
       > dataDir=/var/lib/zookeeper
       > clientPort=2181
       > EOF
       # export JAVA_HOME=/usr/java/jdk1.8.0_51
       # /usr/local/zookeeper/bin/zkServer.sh start
       JMX enabled by default
       Using config: /usr/local/zookeeper/bin/../conf/zoo.cfg
       Starting zookeeper ... STARTED
       #

   验证 Zookeeper 是否安装正确

       # telnet localhost 2181
       Trying ::1...
       Connected to localhost.
       Escape character is '^]'.
       srvr
       Zookeeper version: 3.4.6-1569965, built on 02/20/2014 09:09 GMT
       Latency min/avg/max: 0/0/0
       Received: 1
       Sent: 0
       Connections: 1
       Outstanding: 0
       Zxid: 0x0
       Mode: standalone
       Node count: 4
       Connection closed by foreign host.
       #

2. Zookeeper 群组(Ensemble)

   - Zookeeper 集群被称为群组

   - Zookeeper 使用一致性协议

     - 建议每个群组里应该包含奇数个节点(比如 3 个、5 个等)

     - 只有当群组里的大多数节点(也就是法定人数)处于可用状态, Zookeeper 才能处理外部的请求

       - 如果你有一个包含 3 个节点的群组, 那么它允许一个节点失效

       - 如果群组包含 5 个节点, 那么它允许 2 个节点失效

   群组些公共配置文件举例


